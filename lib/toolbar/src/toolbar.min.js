"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireWildcard(require("../../v-x-e-table")),_tools=require("../../tools");function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var t=new WeakMap;return _getRequireWildcardCache=function(){return t},t}function _interopRequireWildcard(t){if(t&&t.__esModule)return t;var e=_getRequireWildcardCache();if(e&&e.has(t))return e.get(t);var i={};if(null!=t){var o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r)){var n=o?Object.getOwnPropertyDescriptor(t,r):null;n&&(n.get||n.set)?Object.defineProperty(i,r,n):i[r]=t[r]}}return i.default=t,e&&e.set(t,i),i}function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var _default2={name:"VxeToolbar",props:{id:String,loading:!1,resizable:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.resizable}},refresh:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.refresh}},export:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.export}},setting:{type:[Boolean,Object],default:function(){return _conf.default.toolbar.setting}},buttons:{type:Array,default:function(){return _conf.default.toolbar.buttons}},size:String,data:Array,customs:Array},inject:{$grid:{default:null}},data:function(){return{$table:null,isRefresh:!1,tableFullColumn:[],exportStore:{name:"",mode:"",columns:[],selectRecords:[],hasFooter:!1,forceOriginal:!1,visible:!1},exportParams:{filename:"",type:"",original:!1,isHeader:!1,isFooter:!1},settingStore:{visible:!1}}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},refreshOpts:function(){return Object.assign({},_conf.default.toolbar.refresh,this.refresh)},exportOpts:function(){return Object.assign({types:["csv","html","xml"]},_conf.default.toolbar.export,this.export)},resizableOpts:function(){return Object.assign({storageKey:"VXE_TABLE_CUSTOM_COLUMN_WIDTH"},_conf.default.toolbar.resizable,this.resizable)},settingOpts:function(){return Object.assign({storageKey:"VXE_TABLE_CUSTOM_COLUMN_HIDDEN"},_conf.default.toolbar.setting,this.setting)}},created:function(){var t=this,e=this.settingOpts,i=this.id,o=this.customs;if(o&&(this.tableFullColumn=o),e.storage&&!i)return _tools.UtilTools.error("vxe.error.toolbarId");!_vXETable.default._export&&this.export&&_tools.UtilTools.error("vxe.error.reqModule",["Export"]),this.$nextTick(function(){t.updateConf(),t.loadStorage()}),_tools.GlobalEvent.on(this,"mousedown",this.handleGlobalMousedownEvent),_tools.GlobalEvent.on(this,"blur",this.handleGlobalBlurEvent)},destroyed:function(){_tools.GlobalEvent.off(this,"mousedown"),_tools.GlobalEvent.off(this,"blur")},render:function(n){var t,s=this,i=this._e,e=this.$scopedSlots,o=this.$grid,r=this.$table,l=this.loading,a=this.settingStore,u=this.refresh,c=this.setting,h=this.settingOpts,f=this.buttons,d=void 0===f?[]:f,p=this.vSize,v=this.tableFullColumn,g=this.exportOpts,b=this.exportStore,m=this.exportParams,x={},_={},S=e.buttons,y=e.tools;return c&&("manual"===h.trigger||("hover"===h.trigger?(x.mouseenter=this.handleMouseenterSettingEvent,x.mouseleave=this.handleMouseleaveSettingEvent,_.mouseenter=this.handleWrapperMouseenterEvent,_.mouseleave=this.handleWrapperMouseleaveEvent):x.click=this.handleClickSettingEvent)),n("div",{class:["vxe-toolbar",(t={},_defineProperty(t,"size--".concat(p),p),_defineProperty(t,"is--loading",l),t)]},[n("div",{class:"vxe-button--wrapper"},S?S.call(this,{$grid:o,$table:r},n):d.map(function(e){return!1===e.visible?i():n("vxe-button",{on:{click:function(t){return s.btnEvent(t,e)}},props:{disabled:e.disabled},scopedSlots:e.dropdowns&&e.dropdowns.length?{default:function(){return _tools.UtilTools.getFuncText(e.name)},dropdowns:function(){return e.dropdowns.map(function(e){return!1===e.visible?i():n("vxe-button",{on:{click:function(t){return s.btnEvent(t,e)}},props:{disabled:e.disabled}},_tools.UtilTools.getFuncText(e.name))})}}:null},_tools.UtilTools.getFuncText(e.name))})),n("div",{class:"vxe-tools--operate"},[this.export?n("vxe-button",{class:"vxe-export--btn",props:{type:"text",icon:_conf.default.icon.export},on:{click:this.clickExportEvent}}):null,u?n("vxe-button",{class:"vxe-refresh--btn",props:{type:"text",icon:_conf.default.icon.refresh,loading:this.isRefresh},on:{click:this.refreshEvent}}):null,c?n("div",{class:["vxe-custom--wrapper",{"is--active":a.visible}],ref:"customWrapper"},[n("div",{class:"vxe-custom--setting-btn",on:x},[n("i",{class:_conf.default.icon.custom})]),n("div",{class:"vxe-custom--option-wrapper"},[n("div",{class:"vxe-custom--option",on:_},v.map(function(e){var t=e.property,i=e.visible,o=e.own,r=_tools.UtilTools.getFuncText(o.title||o.label);return t&&r?n("vxe-checkbox",{props:{value:i},attrs:{title:r},on:{change:function(t){e.visible=t,c&&h.immediate&&s.updateSetting()}}},r):null}))])]):null]),this.export?n("vxe-export-panel",{props:{exportOpts:g,exportStore:b,exportParams:m},on:{export:this.confirmExportEvent}}):i(),y?n("div",{class:"vxe-tools--wrapper"},y.call(this,{$grid:o,$table:r},n)):null])},methods:{updateConf:function(){var t=this.$parent,i=this.data,e=t.$children,o=e.indexOf(this);this.$table=e.find(function(t,e){return t&&t.refreshColumn&&o<e&&(i?t.data===i:"vxe-table"===t.$vnode.componentOptions.tag)})},openSetting:function(){this.settingStore.visible=!0},closeSetting:function(){var t=this.setting,e=this.settingStore;e.visible&&(e.visible=!1,t&&!e.immediate&&this.updateSetting())},loadStorage:function(){var t=this.$grid,e=this.$table,i=this.id,o=this.refresh,r=this.resizable,n=this.setting,s=this.refreshOpts,l=this.resizableOpts,a=this.settingOpts;if(o&&!t&&(s.query||_tools.UtilTools.warn("vxe.error.notFunc",["query"])),r||n){if(!t&&!e)throw new Error(_tools.UtilTools.getLog("vxe.error.barUnableLink"));(t||e).connect({toolbar:this});var u={};if(l.storage){var c=this.getStorageMap(l.storageKey)[i];c&&_xeUtils.default.each(c,function(t,e){u[e]={field:e,resizeWidth:t}})}if(a.storage){var h=this.getStorageMap(a.storageKey)[i];h&&h.split(",").forEach(function(t){u[t]?u[t].visible=!1:u[t]={field:t,visible:!1}})}var f=Object.values(u);this.updateCustoms(f.length?f:this.tableFullColumn)}},updateColumn:function(t){this.tableFullColumn=t},updateCustoms:function(t){var e=this,i=this.$grid,o=this.$table,r=i||o;r&&r.reloadCustoms(t).then(function(t){e.tableFullColumn=t})},getStorageMap:function(t){var e=_conf.default.version,i=_xeUtils.default.toStringJSON(localStorage.getItem(t));return i&&i._v===e?i:{_v:e}},saveColumnHide:function(){var t=this.id,e=this.tableFullColumn,i=this.settingOpts;if(i.storage){var o=this.getStorageMap(i.storageKey),r=e.filter(function(t){return t.property&&!t.visible});o[t]=r.length?r.map(function(t){return t.property}).join(","):void 0,localStorage.setItem(i.storageKey,_xeUtils.default.toJSONString(o))}return this.$nextTick()},saveColumnWidth:function(t){var e=this.id,i=this.tableFullColumn,o=this.resizableOpts;if(o.storage){var r,n=this.getStorageMap(o.storageKey);t||(r=_xeUtils.default.isPlainObject(n[e])?n[e]:{},i.forEach(function(t){var e=t.property,i=t.resizeWidth,o=t.renderWidth;e&&i&&(r[e]=o)})),n[e]=_xeUtils.default.isEmpty(r)?void 0:r,localStorage.setItem(o.storageKey,_xeUtils.default.toJSONString(n))}return this.$nextTick()},hideColumn:function(t){return _tools.UtilTools.warn("vxe.error.delFunc",["hideColumn","table.hideColumn"]),t.visible=!1,this.updateSetting()},showColumn:function(t){return _tools.UtilTools.warn("vxe.error.delFunc",["showColumn","table.showColumn"]),t.visible=!0,this.updateSetting()},resetCustoms:function(){return this.updateSetting()},resetResizable:function(){this.updateResizable(this)},updateResizable:function(t){var e=this.$grid,i=this.$table,o=e||i;return this.saveColumnWidth(t),o.analyColumnWidth(),o.recalculate(!0)},updateSetting:function(){return(this.$grid||this.$table).refreshColumn(),this.saveColumnHide()},handleGlobalMousedownEvent:function(t){_tools.DomTools.getEventTargetNode(t,this.$refs.customWrapper).flag||this.closeSetting()},handleGlobalBlurEvent:function(t){this.closeSetting()},handleClickSettingEvent:function(t){var e=this.settingStore;e.visible=!e.visible},handleMouseenterSettingEvent:function(t){this.settingStore.activeBtn=!0,this.openSetting()},handleMouseleaveSettingEvent:function(t){var e=this,i=this.settingStore;i.activeBtn=!1,setTimeout(function(){i.activeBtn||i.activeWrapper||e.closeSetting()},300)},handleWrapperMouseenterEvent:function(t){this.settingStore.activeWrapper=!0,this.openSetting()},handleWrapperMouseleaveEvent:function(t){var e=this,i=this.settingStore;i.activeWrapper=!1,setTimeout(function(){i.activeBtn||i.activeWrapper||e.closeSetting()},300)},refreshEvent:function(){var t=this,e=this.$grid,i=this.refreshOpts;this.isRefresh||(i.query?(this.isRefresh=!0,i.query().catch(function(t){return t}).then(function(){t.isRefresh=!1})):e&&(this.isRefresh=!0,e.commitProxy("reload").catch(function(t){return t}).then(function(){t.isRefresh=!1})))},btnEvent:function(t,e){var i=this.$grid,o=this.$table,r=e.code;if(r)if(i)i.triggerToolbarBtnEvent(e,t);else{var n=_vXETable.Buttons.get(r),s={code:r,button:e,$grid:i,$table:o};n&&n.call(this,s,t),_tools.UtilTools.emitEvent(this,"button-click",[s,t])}},clickExportEvent:function(){var t=this.$grid,e=this.$table,i=this.exportOpts,o=this.exportStore,r=this.exportParams,n=t||e,s=n.getTableColumn().fullColumn,l=n.getTableData().footerData,a=n.getSelectRecords(),u=n.getVirtualScroller(),c=s.filter(function(t){return"index"===t.type||t.property&&-1===["checkbox","selection","radio"].indexOf(t.type)}),h=n.getTreeStatus(),f=!!h||u.scrollX||u.scrollY,d=!!l.length;c.forEach(function(t){t.checked="index"!==t.type}),Object.assign(o,{columns:c,selectRecords:a,mode:a.length?"selected":"all",forceOriginal:!!h||u.scrollX||u.scrollY,hasFooter:!!l.length,visible:!0}),Object.assign(r,{filename:i.filename,type:i.types[0],original:f,isHeader:!0,isFooter:d})},confirmExportEvent:function(t){var e=this.$grid,i=this.$table;(e||i).exportData(t)}}};exports.default=_default2;