"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_vXETable=_interopRequireWildcard(require("../../v-x-e-table")),_tools=require("../../tools");function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return _getRequireWildcardCache=function(){return e},e}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t=_getRequireWildcardCache();if(t&&t.has(e))return t.get(e);var r={};if(null!=e){var o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in e)if(Object.prototype.hasOwnProperty.call(e,l)){var i=o?Object.getOwnPropertyDescriptor(e,l):null;i&&(i.get||i.set)?Object.defineProperty(r,l,i):r[l]=e[l]}}return r.default=e,t&&t.set(e,r),r}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var browse=_tools.DomTools.browse,_default={methods:{_insert:function(e){return this.insertAt(e)},_insertAt:function(e,t){var r=this,o=this.afterFullData,l=this.editStore,i=this.scrollYLoad,n=this.tableFullData;if(this.treeConfig)throw new Error(_tools.UtilTools.getLog("vxe.error.noTree",["insert"]));_xeUtils.default.isArray(e)||(e=[e]);var s=o,a=e.map(function(e){return r.defineField(Object.assign({},e))});if(t)if(-1===t)s.push.apply(s,a),n.push.apply(n,a);else{var c=s.indexOf(t);if(-1===c)throw new Error(_tools.UtilTools.error("vxe.error.unableInsert"));s.splice.apply(s,[c,0].concat(a)),n.splice.apply(n,[n.indexOf(t),0].concat(a))}else s.unshift.apply(s,a),n.unshift.apply(n,a);return[].unshift.apply(l.insertList,a),this.handleTableData(),this.updateCache(),this.checkSelectionStatus(),i&&this.updateScrollYSpace(),this.$nextTick().then(function(){return r.recalculate(),{row:a.length?a[a.length-1]:null,rows:a}})},_remove:function(t){var e=this,r=this.afterFullData,o=this.tableFullData,l=this.editStore,i=this.treeConfig,n=this.selection,s=this.isInsertByRow,a=this.scrollYLoad,c=l.removeList,u=l.insertList,d=(this.checkboxConfig||this.selectConfig||{}).checkField,h=[],f=r;if(i)throw new Error(_tools.UtilTools.getLog("vxe.error.noTree",["remove"]));return t?_xeUtils.default.isArray(t)||(t=[t]):t=o,t.forEach(function(e){s(e)||c.push(e)}),d||_xeUtils.default.remove(n,function(e){return-1<t.indexOf(e)}),o===t?(t=h=o.slice(0),o.length=0,f.length=0):(h=_xeUtils.default.remove(o,function(e){return-1<t.indexOf(e)}),_xeUtils.default.remove(f,function(e){return-1<t.indexOf(e)})),_xeUtils.default.remove(u,function(e){return-1<t.indexOf(e)}),this.handleTableData(),this.updateCache(),this.checkSelectionStatus(),a&&this.updateScrollYSpace(),this.$nextTick().then(function(){return e.recalculate(),{row:h.length?h[h.length-1]:null,rows:h}})},_removeSelecteds:function(){var t=this;return this.remove(this.getSelectRecords()).then(function(e){return t.clearSelection(),e})},_revert:function(){return _tools.UtilTools.warn("vxe.error.delFunc",["revert","revertData"]),this.revertData.apply(this,arguments)},_revertData:function(e,o){var l=this.tableSourceData,i=this.getRowIndex;return arguments.length?(e&&!_xeUtils.default.isArray(e)&&(e=[e]),e.forEach(function(e){var t=i(e),r=l[t];r&&e&&(o?_xeUtils.default.set(e,o,_xeUtils.default.get(r,o)):_xeUtils.default.destructuring(e,r))}),this.$nextTick()):this.reloadData(l)},_getRecordset:function(){return{insertRecords:this.getInsertRecords(),removeRecords:this.getRemoveRecords(),updateRecords:this.getUpdateRecords()}},_getInsertRecords:function(){return this.editStore.insertList},_getRemoveRecords:function(){return this.editStore.removeList},_getUpdateRecords:function(){var e=this.tableFullData,t=this.isUpdateByRow,r=this.treeConfig;return r?_xeUtils.default.filterTree(e,function(e){return t(e)},r):e.filter(function(e){return t(e)})},handleActived:function(e,t){var r=this,o=this.editStore,l=this.editConfig,i=this.tableColumn,n=l.activeMethod,s=o.actived,a=e.row,c=e.column,u=e.cell;if(c.editRender&&u)if(s.row!==a||"cell"===l.mode&&s.column!==c){var d="edit-disabled";n&&!n(e)||((this.keyboardConfig||this.mouseConfig)&&(this.clearCopyed(t),this.clearChecked(),this.clearSelected(t)),this.clostTooltip(),this.clearActived(t),d="edit-actived",c.renderHeight=u.offsetHeight,s.args=e,s.row=a,s.column=c,"row"===l.mode?i.forEach(function(e){return r._getColumnModel(a,e)}):this._getColumnModel(a,c),this.$nextTick(function(){r.handleFocus(e,t)})),_tools.UtilTools.emitEvent(this,d,[e,t])}else{var h=s.column;if(h!==c){var f=h.model;f.update&&_tools.UtilTools.setCellValue(a,h,f.value),this.clearValidate()}c.renderHeight=u.offsetHeight,s.args=e,s.column=c,setTimeout(function(){r.handleFocus(e,t)})}return this.$nextTick()},_getColumnModel:function(e,t){var r=t.model;t.editRender&&(r.value=_tools.UtilTools.getCellValue(e,t),r.update=!1)},_setColumnModel:function(e,t){var r=t.model;t.editRender&&r.update&&(_tools.UtilTools.setCellValue(e,t,r.value),r.update=!1,r.value=null)},_clearActived:function(e){var t=this,r=this.tableColumn,o=this.editStore,l=this.editConfig,i=void 0===l?{}:l,n=o.actived,s=n.args,a=n.row,c=n.column;return(a||c)&&("row"===i.mode?r.forEach(function(e){return t._setColumnModel(a,e)}):this._setColumnModel(a,c),this.updateFooter(),_tools.UtilTools.emitEvent(this,"edit-closed",[s,e])),n.args=null,n.row=null,n.column=null,(_vXETable.default._valid?this.clearValidate():this.$nextTick()).then(this.recalculate)},_getActiveRow:function(){var e=this.$el,t=this.editStore,r=this.tableData,o=t.actived,l=o.args,i=o.row;return l&&-1<r.indexOf(i)&&e.querySelectorAll(".vxe-body--column.col--actived").length?Object.assign({},l):null},_hasActiveRow:function(e){return _tools.UtilTools.warn("vxe.error.delFunc",["hasActiveRow","isActiveByRow"]),this.isActiveByRow(e)},_isActiveByRow:function(e){return this.editStore.actived.row===e},handleFocus:function(e,t){var r=e.row,o=e.column,l=e.cell,i=o.editRender;if(i){var n,s=_vXETable.Renderer.get(i.name),a=i.autofocus,c=i.autoselect;if(a&&(n=l.querySelector(a)),!n&&s&&s.autofocus&&(n=l.querySelector(s.autofocus)),n){if(n[c?"select":"focus"](),browse.msie){var u=n.createTextRange();u.collapse(!1),u.select()}}else this.scrollToRow(r,o)}},_setActiveRow:function(e){return this.setActiveCell(e,_xeUtils.default.find(this.visibleColumn,function(e){return e.editRender}).property)},_setActiveCell:function(r,o){var l=this;return this.scrollToRow(r,!0).then(function(){if(r&&o){var e=_xeUtils.default.find(l.visibleColumn,function(e){return e.property===o});if(e&&e.editRender){var t=_tools.DomTools.getCell(l,{row:r,column:e});t&&(l.handleActived({row:r,rowIndex:l.getRowIndex(r),column:e,columnIndex:l.getColumnIndex(e),cell:t,$table:l}),l.lastCallTime=Date.now())}}return l.$nextTick()})},_setSelectCell:function(e,t){var r=this.tableData,o=this.editConfig,l=this.visibleColumn;if(e&&t&&"manual"!==o.trigger){var i=_xeUtils.default.find(l,function(e){return e.property===t}),n=r.indexOf(e);if(-1<n&&i){var s=_tools.DomTools.getCell(this,{row:e,rowIndex:n,column:i}),a={row:e,rowIndex:n,column:i,columnIndex:l.indexOf(i),cell:s};this.handleSelected(a,{})}}return this.$nextTick()},handleSelected:function(t,r){var o=this,e=this.mouseConfig,l=void 0===e?{}:e,i=this.editConfig,n=this.editStore,s=this.elemStore,a=n.actived,c=n.selected,u=t.row,d=t.column,h=t.cell;return function(){if((l.selected||l.checked)&&(c.row!==u||c.column!==d)&&(a.row!==u||"cell"===i.mode&&a.column!==d)&&(o.keyboardConfig&&(o.clearChecked(r),o.clearIndexChecked(),o.clearHeaderChecked(),o.clearSelected(r)),o.clearActived(r),c.args=t,c.row=u,c.column=d,l.selected&&o.addColSdCls(),l.checked)){var e=s["main-header-list"];o.handleChecked([[h]]),e&&o.handleHeaderChecked([[e.querySelector(".".concat(d.id))]]),o.handleIndexChecked([[h.parentNode.querySelector(".col--index")]])}return o.$nextTick()}()},_clearSelected:function(e){var t=this.editStore.selected;return t.row=null,t.column=null,this.reColTitleSdCls(),this.reColSdCls(),this.$nextTick()},reColTitleSdCls:function(){var e=this.elemStore["main-header-list"];e&&_xeUtils.default.arrayEach(e.querySelectorAll(".col--title-selected"),function(e){return _tools.DomTools.removeClass(e,"col--title-selected")})},reColSdCls:function(){var e=this.$el.querySelector(".col--selected");e&&_tools.DomTools.removeClass(e,"col--selected")},addColSdCls:function(){var e=this.editStore.selected,t=e.row,r=e.column;if(this.reColSdCls(),t&&r){var o=_tools.DomTools.getCell(this,{row:t,column:r});o&&_tools.DomTools.addClass(o,"col--selected")}}}};exports.default=_default;