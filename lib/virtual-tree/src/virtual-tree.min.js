"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_table=_interopRequireDefault(require("../../table")),_grid=_interopRequireDefault(require("../../grid")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var propKeys=Object.keys(_table.default.props).filter(function(e){return-1===["data","treeConfig"].indexOf(e)}),_default={name:"VxeVirtualTree",extends:_grid.default,data:function(){return{}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},tableProps:function(){var t=this,n={};return propKeys.forEach(function(e){n[e]=t[e]}),n}},watch:{columns:function(e){this.loadColumn(this.handleColumns())},data:function(e){this.loadData(e)}},created:function(){var e=(window.aa=this).data;Object.assign(this,{fullTreeData:[],tableData:[]}),this.handleColumns(),e&&this.reloadData(e)},methods:{renderTreeIcon:function(e,t){var n=this,r=e.isHidden,i=e.row,a=this.treeConfig,s=a.children,l=a.indent,o=a.trigger,u=a.iconOpen,f=a.iconClose,c=i[s],h=!1,d={};return r||(h=i._X_EXPAND),o&&"default"!==o||(d.click=function(e){return n.toggleTreeExpansion(i)}),[t("span",{class:"vxe-tree--indent",style:{width:"".concat(i._X_LEVEL*(l||20),"px")}}),t("span",{class:["vxe-tree-wrapper",{"is--active":h}],on:d},c&&c.length?[t("span",{class:"vxe-tree--btn-wrapper"},[t("i",{class:["vxe-tree--node-btn",h?u||_conf.default.icon.treeOpen:f||_conf.default.icon.treeClose]})])]:[])]},_loadTreeData:function(e){var t=this;return this.$nextTick().then(function(){return t.$refs.xTable.loadData(e)})},loadData:function(e){return this._loadTreeData(this.toVirtualTree(e))},reloadData:function(e){var t=this;return this.$nextTick().then(function(){return t.$refs.xTable.reloadData(t.toVirtualTree(e))}).then(function(){return t.handleDefaultTreeExpand()})},isTreeExpandByRow:function(e){return!!e._X_EXPAND},setTreeExpansion:function(e,t){var n=this;return e&&(_xeUtils.default.isArray(e)||(e=[e]),e.forEach(function(e){return n.virtualExpand(e,!!t)})),this._loadTreeData(this.tableData)},setAllTreeExpansion:function(e){return this._loadTreeData(this.virtualAllExpand(e))},toggleTreeExpansion:function(e){return this._loadTreeData(this.virtualExpand(e,!e._X_EXPAND))},getTreeExpandRecords:function(){var t=this.hasChilds,n=[];return _xeUtils.default.eachTree(this.fullTreeData,function(e){e._X_EXPAND&&t(e)&&n.push(e)},this.treeConfig),n},clearTreeExpand:function(){return this.setAllTreeExpansion(!1)},handleColumns:function(){var n=this;return this.columns.map(function(e){if(e.treeNode){var t=e.slots||{};t.icon=n.renderTreeIcon,e.slots=t}return e})},hasChilds:function(e){var t=e[this.treeConfig.children];return t&&t.length},getRecordset:function(){return{insertRecords:this.getInsertRecords(),removeRecords:this.getRemoveRecords(),updateRecords:this.getUpdateRecords()}},isInsertByRow:function(e){return!!e._X_INSERT},getInsertRecords:function(){var t=[];return _xeUtils.default.eachTree(this.fullTreeData,function(e){e._X_INSERT&&t.push(e)},this.treeConfig),t},insert:function(e){return this.insertAt(e)},insertAt:function(e,t){var n=this,r=this.fullTreeData,i=this.tableData;_xeUtils.default.isArray(e)||(e=[e]);var a=e.map(function(e){return n.defineField(Object.assign({_X_EXPAND:!1,_X_INSERT:!0,_X_LEVEL:0},e))});if(t)if(-1===t)r.push.apply(r,a),i.push.apply(i,a);else{var s=_xeUtils.default.findTree(r,function(e){return e===t});if(!s||-1===s.index)throw new Error(_tools.UtilTools.error("vxe.error.unableInsert"));var l=s.items,o=s.index,u=s.nodes,f=i.indexOf(t);-1<f&&i.splice.apply(i,[f,0].concat(a)),l.splice.apply(l,[o,0].concat(a)),a.forEach(function(e){e._X_LEVEL=u.length-1})}else r.unshift.apply(r,a),i.unshift.apply(i,a);return this._loadTreeData(i).then(function(){return{row:a.length?a[a.length-1]:null,rows:a}})},handleDefaultTreeExpand:function(){var r=this,i=this.treeConfig,a=this.tableFullData;if(i){var e=i.expandAll,t=i.expandRowKeys,s=i.children;if(e)this.setAllTreeExpansion(!0);else if(t){var l=_tools.UtilTools.getRowkey(this);t.forEach(function(t){var e=_xeUtils.default.findTree(a,function(e){return t===_xeUtils.default.get(e,l)},i),n=e?e.item[s]:0;n&&n.length&&r.setTreeExpansion(e.item,!0)})}}},toVirtualTree:function(e){return _xeUtils.default.eachTree(e,function(e,t,n,r,i,a){e._X_EXPAND=!1,e._X_INSERT=!1,e._X_LEVEL=a.length-1}),this.fullTreeData=e.slice(0),this.tableData=e.slice(0),e},virtualExpand:function(e,t){var n=this.treeConfig.children;if(e._X_EXPAND!==t&&this.hasChilds(e)){var r=e[n],i=this.tableData;if(e._X_EXPAND){var a=[];_xeUtils.default.eachTree(r,function(e){a.push(e)},this.treeConfig),i=i.filter(function(e){return-1===a.indexOf(e)})}else{var s=[],l=i.indexOf(e);if(-1===l)throw new Error("错误的操作！");_xeUtils.default.eachTree(r,function(e,t,n,r,i,a){i&&!i._X_EXPAND||s.push(e)},this.treeConfig),i.splice.apply(i,[l+1,0].concat(s))}e._X_EXPAND=!e._X_EXPAND,this.tableData=i}return this.tableData},virtualAllExpand:function(t){var n=this;return _xeUtils.default.eachTree(this.fullTreeData,function(e){n.virtualExpand(e,t)},this.treeConfig),this.tableData}}};exports.default=_default;