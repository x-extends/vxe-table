"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_tools=require("../../tools"),_vXETable=_interopRequireDefault(require("../../v-x-e-table"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function getFileTypes(){return Object.keys(_vXETable.default.types)}function handleExport(t,e,o,n){var r=getExportData(t,e,n,o),a=r.columns,i=r.datas;return t.preventEvent(null,"event.export",{$table:t,options:e,columns:a,datas:i},function(){return downloadFile(e,getContent(t,e,a,i))})}function getContent(t,e,o,n){switch(e.type){case"csv":return toCsv(t,e,o,n);case"txt":return toTxt(t,e,o,n);case"html":return toHtml(t,e,o,n);case"xml":return toXML(t,e,o,n)}return""}function getHeaderTitle(t,e){return t.original?e.property:e.getTitle()}function toCsv(t,e,n,o){var r=e.original,a="\ufeff";if(e.isHeader&&(a+=n.map(function(t){return'"'.concat(getHeaderTitle(e,t),'"')}).join(",")+"\n"),o.forEach(function(e,o){a+=r?n.map(function(t){return"index"===t.type?'"'.concat(t.indexMethod?t.indexMethod(o):o+1,'"'):'"'.concat(_tools.UtilTools.getCellValue(e,t)||"",'"')}).join(",")+"\n":n.map(function(t){return'"'.concat(e[t.id],'"')}).join(",")+"\n"}),e.isFooter){var i=t.footerData,l=e.footerFilterMethod?i.filter(e.footerFilterMethod):i,c=t.tableColumn.map(function(t){return n.includes(t)});l.forEach(function(t){a+=t.filter(function(t,e){return'"'.concat(c[e],'"')}).join(",")+"\n"})}return a}function toTxt(t,e,n,o){var r=e.original,a="";if(e.isHeader&&(a+=n.map(function(t){return"".concat(getHeaderTitle(e,t))}).join("\t")+"\n"),o.forEach(function(e,o){a+=r?n.map(function(t){return"index"===t.type?"".concat(t.indexMethod?t.indexMethod(o):o+1):"".concat(_tools.UtilTools.getCellValue(e,t)||"")}).join("\t")+"\n":n.map(function(t){return"".concat(e[t.id])}).join("\t")+"\n"}),e.isFooter){var i=t.footerData,l=e.footerFilterMethod?i.filter(e.footerFilterMethod):i,c=t.tableColumn.map(function(t){return n.includes(t)});l.forEach(function(t){a+=t.filter(function(t,e){return"".concat(c[e])}).join("\t")+"\n"})}return a}function toHtml(t,e,n,o){var r=e.original,a=["<!DOCTYPE html>","<html>",'<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,minimal-ui"><title>'.concat(e.sheetName,"</title></head>"),"<body>",'<table border="1" cellspacing="0" cellpadding="0">',"<colgroup>".concat(n.map(function(t){return'<col width="'.concat(t.renderWidth,'">')}).join(""),"</colgroup>")].join("");if(e.isHeader&&(a+="<thead><tr>".concat(n.map(function(t){return"<th>".concat(getHeaderTitle(e,t),"</th>")}).join(""),"</tr></thead>")),o.length&&(a+="<tbody>",o.forEach(function(e,o){a+="<tr>",a+=r?n.map(function(t){return"index"===t.type?"<td>".concat(t.indexMethod?t.indexMethod(o):o+1,"</td>"):"<td>".concat(_tools.UtilTools.getCellValue(e,t)||"","</td>")}).join(""):n.map(function(t){return"<td>".concat(e[t.id],"</td>")}).join(""),a+="</tr>"}),a+="</tbody>"),e.isFooter){var i=t.footerData,l=e.footerFilterMethod?i.filter(e.footerFilterMethod):i,c=t.tableColumn.map(function(t){return n.includes(t)});l.length&&(a+="<tfoot>",l.forEach(function(t){a+="<tr>".concat(t.filter(function(t,e){return"<td>".concat(c[e],"</td>")}).join(""),"</tr>")}),a+="</tfoot>")}return a+"</table></body></html>"}function toXML(t,e,n,o){var r=e.original,a=['<?xml version="1.0"?>','<?mso-application progid="Excel.Sheet"?>','<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40">','<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">',"<Version>16.00</Version>","</DocumentProperties>",'<ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">',"<WindowHeight>7920</WindowHeight>","<WindowWidth>21570</WindowWidth>","<WindowTopX>32767</WindowTopX>","<WindowTopY>32767</WindowTopY>","<ProtectStructure>False</ProtectStructure>","<ProtectWindows>False</ProtectWindows>","</ExcelWorkbook>",'<Worksheet ss:Name="'.concat(e.sheetName,'">'),"<Table>",n.map(function(t){return'<Column ss:Width="'.concat(t.renderWidth,'"/>')}).join("")].join("");if(e.isHeader&&(a+="<Row>".concat(n.map(function(t){return'<Cell><Data ss:Type="String">'.concat(getHeaderTitle(e,t),"</Data></Cell>")}).join(""),"</Row>")),o.forEach(function(e,o){a+="<Row>",a+=r?n.map(function(t){return"index"===t.type?'<Cell><Data ss:Type="String">'.concat(t.indexMethod?t.indexMethod(o):o+1,"</Data></Cell>"):'<Cell><Data ss:Type="String">'.concat(_tools.UtilTools.getCellValue(e,t)||"","</Data></Cell>")}).join(""):n.map(function(t){return'<Cell><Data ss:Type="String">'.concat(e[t.id],"</Data></Cell>")}).join(""),a+="</Row>"}),e.isFooter){var i=t.footerData,l=e.footerFilterMethod?i.filter(e.footerFilterMethod):i,c=t.tableColumn.map(function(t){return n.includes(t)});l.length&&l.forEach(function(t){a+="<Row>".concat(t.filter(function(t,e){return'<Cell><Data ss:Type="String">'.concat(c[e],"</Data></Cell>")}).join(""),"</Row>")})}return"".concat(a,"</Table></Worksheet></Workbook>")}function downloadFile(t,e){var o=t.filename,n=t.type,r=t.download,a="".concat(o,".").concat(n);if(!r)return Promise.resolve(e);if(window.Blob){var i=new Blob([e],{type:"text/".concat(n)});if(navigator.msSaveBlob)navigator.msSaveBlob(i,a);else{var l=document.createElement("a");l.target="_blank",l.download=a,l.href=URL.createObjectURL(i),document.body.appendChild(l),l.click(),document.body.removeChild(l)}}else _tools.UtilTools.error("vxe.error.notExp")}function getLabelData(r,t,e){return e.map(function(o){var n={};return t.forEach(function(t){var e=_tools.DomTools.getCell(r,{row:o,column:t});n[t.id]=e?e.innerText.trim():""}),n})}function getExportData(t,e,o,n){var r=e.columns?e.columns:n,a=e.data||o;return e.columnFilterMethod&&(r=r.filter(e.columnFilterMethod)),e.dataFilterMethod&&(a=a.filter(e.dataFilterMethod)),{columns:r,datas:e.original?a:getLabelData(t,r,a)}}function replaceDoubleQuotation(t){return t.replace(/^"/,"").replace(/"$/,"")}function parseCsv(t,e){var o=e.split("\n"),n=[],r=[];if(o.length){var a=o.slice(1);o[0].split(",").forEach(function(t){var e=replaceDoubleQuotation(t);e&&n.push(e)}),a.forEach(function(t){if(t){var o={};t.split(",").forEach(function(t,e){o[n[e]]=replaceDoubleQuotation(t)}),r.push(o)}})}return{fields:n,rows:r}}function parseTxt(t,e){var o=e.split("\n"),n=[],r=[];if(o.length){var a=o.slice(1);o[0].split("\t").forEach(function(t){t&&n.push(t)}),a.forEach(function(t){if(t){var o={};t.split("\t").forEach(function(t,e){o[n[e]]=replaceDoubleQuotation(t)}),r.push(o)}})}return{fields:n,rows:r}}function parseHTML(t,e){var o=(new DOMParser).parseFromString(e,"text/html").getElementsByTagName("body"),n=[],r=[];if(o.length){var a=o[0].getElementsByTagName("table");if(a.length){var i=a[0].getElementsByTagName("thead");if(i.length){_xeUtils.default.arrayEach(i[0].getElementsByTagName("tr"),function(t){_xeUtils.default.arrayEach(t.getElementsByTagName("th"),function(t){var e=t.textContent;e&&n.push(e)})});var l=a[0].getElementsByTagName("tbody");l.length&&_xeUtils.default.arrayEach(l[0].getElementsByTagName("tr"),function(t){var o={};_xeUtils.default.arrayEach(t.getElementsByTagName("td"),function(t,e){o[n[e]]=t.textContent||""}),r.push(o)})}}}return{fields:n,rows:r}}function parseXML(t,e){var o=(new DOMParser).parseFromString(e,"application/xml").getElementsByTagName("Worksheet"),r=[],a=[];if(o.length){var n=o[0].getElementsByTagName("Table");if(n.length){var i=n[0].getElementsByTagName("Row");i.length&&(_xeUtils.default.arrayEach(i[0].getElementsByTagName("Cell"),function(t){var e=t.textContent;e&&r.push(e)}),_xeUtils.default.arrayEach(i,function(t,e){if(e){var o={},n=t.getElementsByTagName("Cell");_xeUtils.default.arrayEach(n,function(t,e){o[r[e]]=t.textContent}),a.push(o)}}))}}return{fields:r,rows:a}}function checkImportData(t,e,o){var n=[];return t.forEach(function(t){var e=t.property;e&&n.push(e)}),n.every(function(t){return e.includes(t)})}function handleImport(e,t,o){var n=e.tableFullColumn,r=e.importCallback,a={fields:[],rows:[]};switch(o.type){case"csv":a=parseCsv(n,t);break;case"txt":a=parseTxt(n,t);break;case"html":a=parseHTML(n,t);break;case"xml":a=parseXML(n,t)}var i=a,l=i.fields,c=i.rows,s=checkImportData(n,l,c);s?e.createData(c).then(function(t){return e.reloadData(t)}):r||_tools.UtilTools.error("vxe.error.impFields"),r&&r(s)}var _default={methods:{_exportCsv:function(t){return _tools.UtilTools.warn("vxe.error.delFunc",["exportCsv","exportData"]),this.exportData(t)},_openExport:function(t){var e=this.$toolbar;return e?e.openExport(t):this.exportData()},_exportData:function(t){var e=this.visibleColumn,o=this.scrollXLoad,n=this.scrollYLoad,r=this.treeConfig,a=Object.keys(_vXETable.default.types),i=Object.assign({filename:"",sheetName:"",original:!!r,isHeader:!0,isFooter:!0,download:!0,type:"csv",data:null,columns:null,columnFilterMethod:null,dataFilterMethod:null,footerFilterMethod:null},t);if(i.filename||(i.filename="export"),i.sheetName||(i.sheetName="Sheet1"),!a.includes(i.type))throw new Error(_tools.UtilTools.getLog("vxe.error.notType",[i.type]));i.original||(o||n)&&(i.original=!0,_tools.UtilTools.warn("vxe.error.scrollOriginal")),t&&t.columns||(i.columnFilterMethod=function(t){return t.property&&-1===["index","checkbox","selection","radio"].indexOf(t.type)});var l=e,c=this.tableFullData;return r&&(c=_xeUtils.default.toTreeArray(c,r)),handleExport(this,i,l,c)},_importData:function(t){var e=this.$refs,o=e.impForm,n=e.impInput;n.accept=".".concat(getFileTypes().join(", .")),o.reset(),n.click(),this.importCallback=t},fileChangeEvent:function(t){var e=this;if(window.FileReader){var o=t.target.files[0],n=o.name,r=_xeUtils.default.lastIndexOf(n,"."),a=n.substring(r+1,n.length),i={filename:n.substring(0,r),type:a};getFileTypes().includes(a)?this.preventEvent(t,"event.import",{$table:this,options:i,columns:this.tableFullColumn},function(){var t=new FileReader;t.onerror=function(t){_tools.UtilTools.error("vxe.error.notType",[a])},t.onload=function(t){handleImport(e,t.target.result,i)},t.readAsText(o,"UTF-8")}):_tools.UtilTools.error("vxe.error.notType",[a])}else _tools.UtilTools.error("vxe.error.notExp")}}};exports.default=_default;